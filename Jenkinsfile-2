def gv

pipeline {
    agent none  // 不指定全局的服务器, 每个stage都要定义自己的agent{...}
    environment {	// 下面的stage都可以使用这个变量
		    NEW_VERSION = '1.3.0'
	  }
    tools {
		    maven 'Maven'
	  }
    parameters {
        choice(name: 'VERSION', choices: ['1.1.0', '1.2.0', '1.3.0'], description: '')
        booleanParam(name: 'executeTests', defaultValue: true, description: '')
    }
    
    
    stages {
        stage('init') {
            steps {
                script {
                    gv = load "script.groovy"
                }
            }
        }
    
        stage('Environment Test') {
            when {
		            expression {
		                env.GIT_BRANCH == 'origin/dev'
		           }
            }
            agent {
		            node {
		                label 'test-server'
		            }
	           }
            steps {
                gv.environmentTest()
            }
        }
        
      stage('Tools Test') {
          agent {
		          node {
		              label 'test-server'
		          }
	       }
          steps {
              sh 'mvn --version'
          }
      }
	
        stage('Parameters Test') {
            when {
                expression {
                    params.executeTests == true
                }
            }
        
            steps {
                echo "testing version ${params.VERSION}"
            }
      }
    }
	
    post {
		    always {
			      echo 'Here is the always condition ...'
		    }
		    success {
			      echo env.BUILD_TAG + ' build success.'
		    }
		    failure {
			      echo env.BUILD_TAG + ' build failed.'
		    }
    }
}
